"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require('angular2/core');
var router_1 = require('angular2/router');
var hegel_service_1 = require('../../shared/services/hegel.service');
var search_pipe_1 = require('../../search/search-pipe');
var Rx = require('rxjs/Rx');
var browser_1 = require('angular2/platform/browser');
var HegelComponent = (function () {
    function HegelComponent(hegelService, _dom) {
        this.hegelService = hegelService;
        this._dom = _dom;
        this.index = 1;
        this.item = 0;
        this.searchTerm = "";
        this.dictionaries = { info: [] };
        this.previous = [];
    }
    ;
    HegelComponent.prototype.increment = function (num) {
        this.index += num;
        this.getInd(this.index);
    };
    HegelComponent.prototype.getInd = function (num) {
        var _this = this;
        this.hegelService.getHegel(num).subscribe(function (res) { return _this.hegel = res; });
    };
    ;
    HegelComponent.prototype.getTerm = function (term) {
        term = term.replace(/[0-9]/g, '');
        term = term.replace(/\./g, '');
        this.getWiki(term);
    };
    HegelComponent.prototype.handleLink = function ($event) {
        console.log("Link handling");
        var href = $event.target.href;
        href = href.slice(27, href.length);
        this.getWiki(href);
        $event.preventDefault();
    };
    HegelComponent.prototype.handleWikipediaLink = function ($event) {
        console.log("Handling Wiki Link");
        this.hegelService.handleWikipediaLink($event);
        $event.preventDefault();
    };
    HegelComponent.prototype.getWiki = function (word) {
        word = this.hegelService.replaceUnderscoreAndCap(word);
        console.log("Checking word" + word);
        var cacheCheck = this.checkCacheForTerm(word);
        if (cacheCheck.length > 0) {
            this.getCache(word);
        }
        else {
            this.hegelService.requestWiki(word).subscribe();
        }
    };
    HegelComponent.prototype.checkCacheForTerm = function (term) {
        var result = this.previous.filter(function (prev) {
            if (prev.word == term) {
                console.log("Returning", prev.word);
                return prev;
            }
        });
        return result;
    };
    HegelComponent.prototype.getCache = function (term) {
        var _this = this;
        var result = this.previous.filter(function (prev) {
            if (prev.word == term) {
                if (prev.page) {
                    console.log("Getting wiki from cache");
                    _this.wiki = prev.page;
                }
            }
        });
    };
    HegelComponent.prototype.handleCache = function (term) {
        console.log("Handling cache");
        if (typeof (term) == 'String') {
            console.log("Got a string!");
        }
        if (term.page) {
            console.log("Setting page");
            this.wiki = term.page;
        }
    };
    HegelComponent.prototype.getSelectionText = function () {
        var text = "";
        if (window.getSelection) {
            text = window.getSelection().toString();
        }
        else if (document.selection && document.selection.type != "Control") {
            text = document.selection.createRange().text;
        }
        return text;
    };
    HegelComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.getInd(this.index);
        var s = Rx.Observable.fromEvent(this._dom.query('body'), 'click');
        s.subscribe(function (e) {
            console.log(e.target.textContent);
            console.log("Selection text!");
            console.log(_this.getSelectionText());
            try {
                if (e.target.className == "term") {
                    var cacheCheck = _this.checkCacheForTerm(e.target.computedName);
                    if (cacheCheck.length > 0) {
                        console.log("Gotta handle that");
                        _this.handleCache(e);
                    }
                    console.log("Cache check", cacheCheck);
                    if (cacheCheck.length > 0) {
                        _this.handleCache(cacheCheck[0]);
                    }
                    else {
                        console.log("computed name");
                        console.log(e.target.computedName);
                        _this.getTerm("Category:" + e.target.computedName);
                    }
                }
                if (e.target.className == "links") {
                    console.log("link name");
                    console.log(e.originalTarget.innerHtml);
                    _this.getTerm(e.target.textContent);
                    e.preventDefault();
                }
                if (e.target.className == "prevs") {
                    var term = _this.checkCacheForTerm(e.target.computedName);
                    console.log("Logging term from cache", term);
                    _this.handleCache(term[0]);
                }
                else {
                    var term = _this.getSelectionText();
                    _this.getTerm(term);
                }
            }
            catch (ex) {
                console.log(ex);
            }
        });
        function checkForBaddies(cat, baddies) {
            var exists = false;
            baddies.forEach(function (bad) {
                if (cat.indexOf(bad) > -1) {
                    exists = true;
                }
                else {
                }
            });
            return exists;
        }
        function filterOutBadCategories(categories) {
            var results = [];
            var baddies = ["Wikipedia", "Use dmy dates", "Use mdy dates", "All articles", "Articles", "NPOV", "CS1",
                "Commons category with local", "Hidden categories", "Tracking categories", "Pages with URL errors", "disambiguation", "Pages with incorrect ref formatting"];
            categories = categories.filter(function (cat) {
                if (checkForBaddies(cat, baddies) == false) {
                    results.push(cat);
                }
                else {
                    console.log("Bad Category ", cat);
                }
            });
            return results;
        }
        var src = Rx.Observable.fromEvent(this.hegelService.socket, 'wikiSend');
        var subject = new Rx.Subject();
        var multicasted = src.multicast(subject);
        var dicts = [];
        var categories = [];
        multicasted.filter(function (e) { if (e.dictionaries) {
            dicts = e.dictionaries;
            return e.dictionaries;
        } }).subscribe(function (msg) {
            _this.dictionaries = msg.dictionaries;
            _this.defs = msg.dictionaries.info.map(function (entry) {
                return entry.def;
            });
            _this.glosses = msg.dictionaries.info.map(function (def) { return def.gloss; });
        });
        multicasted.filter(function (e) {
            if (e.categories) {
                categories = e.categories;
                return e.categories;
            }
        })
            .subscribe(function (msg) {
            msg = msg.categories;
            _this.dis = false;
            msg = msg.map(function (cat) {
                cat = cat.substring(9, cat.length);
                if (cat.indexOf("All disambiguation pages") > -1) {
                    _this.dis = true;
                }
                return cat;
            });
            var results = filterOutBadCategories(msg);
            _this.terms = results;
        });
        multicasted.filter(function (e) {
            if (e.word) {
                console.log("word", e.word);
                var previousObj = { word: e.word, page: e.page };
                if (previousObj.word !== "") {
                    _this.previous.push(previousObj.word);
                }
            }
            if (e.page) {
                _this.wiki = e.page;
            }
            ;
            return e.page;
        }).subscribe(function (e) { });
        multicasted.filter(function (e) { if (e.results) {
            _this.terms = e.results;
        } ; return e.results; }).subscribe(function (e) {
        });
        multicasted.filter(function (e) { if (e.links) {
            _this.links = e.links;
        } ; return e.links; }).subscribe(function (e) {
        });
        multicasted.connect();
    };
    ;
    HegelComponent = __decorate([
        core_1.Component({
            selector: 'sd-navbar',
            templateUrl: '../hegel/components/hegel.template.html',
            styleUrls: ['../hegel/components/hegel.component.css'],
            directives: [router_1.ROUTER_DIRECTIVES],
            providers: [hegel_service_1.HegelService, browser_1.BrowserDomAdapter],
            pipes: [search_pipe_1.SearchPipe]
        }), 
        __metadata('design:paramtypes', [hegel_service_1.HegelService, browser_1.BrowserDomAdapter])
    ], HegelComponent);
    return HegelComponent;
}());
exports.HegelComponent = HegelComponent;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlZ2VsL2NvbXBvbmVudHMvaGVnZWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxxQkFHTyxlQUFlLENBQUMsQ0FBQTtBQUV2Qix1QkFFTyxpQkFBaUIsQ0FBQyxDQUFBO0FBRXpCLDhCQUVPLHFDQUFxQyxDQUFDLENBQUE7QUFDN0MsNEJBQXlCLDBCQUEwQixDQUFDLENBQUE7QUFFcEQsSUFBWSxFQUFFLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFFOUIsd0JBQWdDLDJCQUEyQixDQUFDLENBQUE7QUFXNUQ7SUFnQkksd0JBQW9CLFlBQTBCLEVBQVUsSUFBdUI7UUFBM0QsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFtQjtRQWQvRSxVQUFLLEdBQVcsQ0FBQyxDQUFDO1FBR2xCLFNBQUksR0FBVyxDQUFDLENBQUM7UUFZYixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUMsSUFBSSxFQUFFLEVBQUUsRUFBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO0lBRXZCLENBQUM7O0lBQ0Qsa0NBQVMsR0FBVCxVQUFVLEdBQVU7UUFDaEIsSUFBSSxDQUFDLEtBQUssSUFBRyxHQUFHLENBQUM7UUFDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUNELCtCQUFNLEdBQU4sVUFBTyxHQUFVO1FBQWpCLGlCQUVDO1FBREcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLEtBQUssR0FBRyxHQUFHLEVBQWhCLENBQWdCLENBQUMsQ0FBQztJQUN2RSxDQUFDOztJQUNELGdDQUFPLEdBQVAsVUFBUSxJQUFXO1FBQ2YsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxtQ0FBVSxHQUFWLFVBQVcsTUFBVTtRQUNqQixPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzdCLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQzlCLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQixNQUFNLENBQUMsY0FBYyxFQUFFLENBQUM7SUFFNUIsQ0FBQztJQUNELDRDQUFtQixHQUFuQixVQUFvQixNQUFVO1FBQzFCLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBQ0QsZ0NBQU8sR0FBUCxVQUFRLElBQVc7UUFDZixJQUFJLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsQ0FBQTtRQUNuQyxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsRUFBRSxDQUFBLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdkIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDcEQsQ0FBQztJQUNMLENBQUM7SUFDRCwwQ0FBaUIsR0FBakIsVUFBa0IsSUFBWTtRQUMxQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQVE7WUFDdkMsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQSxDQUFDO2dCQUNsQixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRyxJQUFJLENBQUMsSUFBSSxDQUFFLENBQUE7Z0JBQ3JDLE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDaEIsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBQ0QsaUNBQVEsR0FBUixVQUFTLElBQVc7UUFBcEIsaUJBU0M7UUFSRyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQVE7WUFDdkMsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQSxDQUFDO2dCQUNsQixFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQztvQkFDVixPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7b0JBQ3ZDLEtBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDMUIsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFDRCxvQ0FBVyxHQUFYLFVBQVksSUFBUTtRQUNoQixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUE7UUFDN0IsRUFBRSxDQUFBLENBQUMsT0FBTSxDQUFDLElBQUksQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFBLENBQUM7WUFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNqQyxDQUFDO1FBQ0QsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBLENBQUM7WUFDVixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFBO1lBQzNCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQTtRQUN6QixDQUFDO0lBQ0wsQ0FBQztJQUNELHlDQUFnQixHQUFoQjtRQUNJLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNkLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLElBQUksR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDNUMsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEUsSUFBSSxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxDQUFDO1FBQ2pELENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxpQ0FBUSxHQUFSO1FBQUEsaUJBK0hDO1FBN0hHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXhCLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2xFLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxDQUFDO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2xDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUMvQixPQUFPLENBQUMsR0FBRyxDQUFFLEtBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUE7WUFDckMsSUFBRyxDQUFDO2dCQUNBLEVBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxDQUFBLENBQUM7b0JBQzdCLElBQUksVUFBVSxHQUFHLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUMvRCxFQUFFLENBQUEsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFBLENBQUM7d0JBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQTt3QkFDaEMsS0FBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEIsQ0FBQztvQkFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRyxVQUFVLENBQUMsQ0FBQTtvQkFDdkMsRUFBRSxDQUFBLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFFLENBQUMsQ0FBQSxDQUFDO3dCQUN2QixLQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNwQyxDQUFDO29CQUFBLElBQUksQ0FBQSxDQUFDO3dCQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUE7d0JBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQTt3QkFDbEMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztvQkFDdEQsQ0FBQztnQkFDTCxDQUFDO2dCQUNELEVBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLE9BQU8sQ0FBQyxDQUFBLENBQUM7b0JBQzlCLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUE7b0JBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQTtvQkFDdkMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUNuQyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUE7Z0JBQ3RCLENBQUM7Z0JBQ0wsRUFBRSxDQUFBLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLENBQUEsQ0FBQztvQkFDOUIsSUFBSSxJQUFJLEdBQUcsS0FBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQ3pELE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLEVBQUcsSUFBSSxDQUFDLENBQUM7b0JBQzlDLEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLENBQUM7Z0JBQ0csSUFBSSxDQUFBLENBQUM7b0JBQ0QsSUFBSSxJQUFJLEdBQUcsS0FBSSxDQUFDLGdCQUFnQixFQUFFLENBQUE7b0JBQ2xDLEtBQUksQ0FBQyxPQUFPLENBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3hCLENBQUM7WUFDTCxDQUFFO1lBQUEsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUEsQ0FBQztnQkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3BCLENBQUM7UUFFTCxDQUFDLENBQUMsQ0FBQTtRQUNELHlCQUF5QixHQUFVLEVBQUUsT0FBVztZQUM3QyxJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUM7WUFDbkIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFDLEdBQVU7Z0JBQ3ZCLEVBQUUsQ0FBQSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFDO29CQUN0QixNQUFNLEdBQUcsSUFBSSxDQUFBO2dCQUNqQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNSLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQTtZQUNELE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDbkIsQ0FBQztRQUVELGdDQUFnQyxVQUFjO1lBQzFDLElBQUksT0FBTyxHQUFRLEVBQUUsQ0FBQztZQUN0QixJQUFJLE9BQU8sR0FBRyxDQUFDLFdBQVcsRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFDLGNBQWMsRUFBQyxVQUFVLEVBQUMsTUFBTSxFQUFFLEtBQUs7Z0JBQ3pGLDZCQUE2QixFQUFFLG1CQUFtQixFQUFFLHFCQUFxQixFQUFFLHVCQUF1QixFQUFHLGdCQUFnQixFQUFFLHFDQUFxQyxDQUFDLENBQUE7WUFDeEssVUFBVSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUUsVUFBQyxHQUFPO2dCQUNwQyxFQUFFLENBQUEsQ0FBQyxlQUFlLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFBLENBQUM7b0JBQ3ZDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQ3JCLENBQUM7Z0JBQUMsSUFBSSxDQUFBLENBQUM7b0JBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQ3ZDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQTtZQUNGLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFDbkIsQ0FBQztRQUVELElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3pFLElBQUksT0FBTyxHQUFHLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQy9CLElBQUksV0FBVyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFekMsSUFBSSxLQUFLLEdBQVMsRUFBRSxDQUFDO1FBQ3JCLElBQUksVUFBVSxHQUFTLEVBQUUsQ0FBQztRQUUxQixXQUFXLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFLLEVBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQSxDQUFDO1lBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUM7WUFBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQTtRQUFBLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxHQUFHO1lBQ3ZHLEtBQUksQ0FBQyxZQUFZLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQztZQUNyQyxLQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFDLEtBQVM7Z0JBQzVDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO1lBQ3JCLENBQUMsQ0FBQyxDQUFBO1lBQ0YsS0FBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQyxHQUFPLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUEsQ0FBQSxDQUFDLENBQUMsQ0FBQztRQUM1RSxDQUFDLENBQUMsQ0FBQTtRQUVGLFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDO1lBQ2hCLEVBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQSxDQUFDO2dCQUNiLFVBQVUsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDO2dCQUMxQixNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztZQUN4QixDQUFDO1FBQUEsQ0FBQyxDQUFDO2FBQ0YsU0FBUyxDQUFDLFVBQUEsR0FBRztZQUNWLEdBQUcsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDO1lBQ3JCLEtBQUksQ0FBQyxHQUFHLEdBQUMsS0FBSyxDQUFDO1lBQ2YsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBQyxHQUFVO2dCQUNyQixHQUFHLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNsQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQSxDQUFDO29CQUM5QyxLQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQztnQkFDcEIsQ0FBQztnQkFDRCxNQUFNLENBQUMsR0FBRyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLENBQUE7WUFDRixJQUFJLE9BQU8sR0FBRyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMxQyxLQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQTtRQUNGLFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDO1lBQ2hCLEVBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFDO2dCQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDNUIsSUFBSSxXQUFXLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBQyxDQUFDO2dCQUNoRCxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFBLENBQUM7b0JBQ3pCLEtBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDekMsQ0FBQztZQUVMLENBQUM7WUFDRCxFQUFFLENBQUEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUEsQ0FBQztnQkFDUCxLQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDdkIsQ0FBQztZQUFBLENBQUM7WUFFRixNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQTtRQUNqQixDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxDQUFDLElBQUssQ0FBQyxDQUFDLENBQUE7UUFFckIsV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSyxFQUFFLENBQUEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUEsQ0FBQztZQUFBLEtBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQTtRQUFBLENBQUMsQ0FBQSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUEsQ0FBQSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxDQUFDO1FBRTlGLENBQUMsQ0FBQyxDQUFBO1FBQ0YsV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSyxFQUFFLENBQUEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUEsQ0FBQztZQUFBLEtBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQTtRQUFBLENBQUMsQ0FBQSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUEsQ0FBQSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxDQUFDO1FBRXhGLENBQUMsQ0FBQyxDQUFBO1FBQ0YsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzFCLENBQUM7O0lBeE9MO1FBQUMsZ0JBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxXQUFXO1lBQ3JCLFdBQVcsRUFBRSx5Q0FBeUM7WUFDdEQsU0FBUyxFQUFFLENBQUMseUNBQXlDLENBQUM7WUFDdEQsVUFBVSxFQUFFLENBQUMsMEJBQWlCLENBQUM7WUFDL0IsU0FBUyxFQUFFLENBQUMsNEJBQVksRUFBRSwyQkFBaUIsQ0FBQztZQUM1QyxLQUFLLEVBQUUsQ0FBQyx3QkFBVSxDQUFDO1NBQ3RCLENBQUM7O3NCQUFBO0lBa09GLHFCQUFDO0FBQUQsQ0FoT0EsQUFnT0MsSUFBQTtBQWhPWSxzQkFBYyxpQkFnTzFCLENBQUE7QUFBQSxDQUFDIiwiZmlsZSI6ImhlZ2VsL2NvbXBvbmVudHMvaGVnZWwuY29tcG9uZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBDb21wb25lbnQsXG4gICAgT25Jbml0XG59IGZyb20gJ2FuZ3VsYXIyL2NvcmUnO1xuXG5pbXBvcnQge1xuICAgIFJPVVRFUl9ESVJFQ1RJVkVTXG59IGZyb20gJ2FuZ3VsYXIyL3JvdXRlcic7XG5cbmltcG9ydCB7XG4gICAgSGVnZWxTZXJ2aWNlXG59IGZyb20gJy4uLy4uL3NoYXJlZC9zZXJ2aWNlcy9oZWdlbC5zZXJ2aWNlJztcbmltcG9ydCB7U2VhcmNoUGlwZX0gZnJvbSAnLi4vLi4vc2VhcmNoL3NlYXJjaC1waXBlJztcblxuaW1wb3J0ICogYXMgUnggZnJvbSAncnhqcy9SeCc7XG5pbXBvcnQge09ic2VydmVyfSBmcm9tIFwicnhqcy9PYnNlcnZlclwiO1xuaW1wb3J0IHtCcm93c2VyRG9tQWRhcHRlcn0gZnJvbSAnYW5ndWxhcjIvcGxhdGZvcm0vYnJvd3Nlcic7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnc2QtbmF2YmFyJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4uL2hlZ2VsL2NvbXBvbmVudHMvaGVnZWwudGVtcGxhdGUuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4uL2hlZ2VsL2NvbXBvbmVudHMvaGVnZWwuY29tcG9uZW50LmNzcyddLFxuICAgIGRpcmVjdGl2ZXM6IFtST1VURVJfRElSRUNUSVZFU10sXG4gICAgcHJvdmlkZXJzOiBbSGVnZWxTZXJ2aWNlLCBCcm93c2VyRG9tQWRhcHRlcl0sXG4gICAgcGlwZXM6IFtTZWFyY2hQaXBlXVxufSlcblxuZXhwb3J0IGNsYXNzIEhlZ2VsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgICBoZWdlbDogQXJyYXk8YW55PjtcbiAgICBpbmRleDogbnVtYmVyID0gMTtcbiAgICB3aWtpOiBhbnk7XG4gICAgdGVybXM6IGFueTtcbiAgICBpdGVtOiBudW1iZXIgPSAwO1xuICAgIHN1YnNjcmlwdGlvbjogYW55O1xuICAgIGRpY3Rpb25hcmllczphbnk7XG4gICAgc3luczphbnk7XG4gICAgZGVmczphbnk7XG4gICAgZ2xvc3Nlczphbnk7XG4gICAgc2VhcmNoVGVybTphbnk7XG4gICAgZGlzOmFueTtcbiAgICBsaW5rczphbnk7XG4gICAgcHJldmlvdXM6YW55O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBoZWdlbFNlcnZpY2U6IEhlZ2VsU2VydmljZSwgcHJpdmF0ZSBfZG9tOiBCcm93c2VyRG9tQWRhcHRlcikge1xuICAgICAgICB0aGlzLnNlYXJjaFRlcm0gPSBcIlwiO1xuICAgICAgICB0aGlzLmRpY3Rpb25hcmllcyA9IHtpbmZvOiBbXX07XG4gICAgICAgIHRoaXMucHJldmlvdXMgPSBbXTtcblxuICAgIH07XG4gICAgaW5jcmVtZW50KG51bTpudW1iZXIpe1xuICAgICAgICB0aGlzLmluZGV4ICs9bnVtO1xuICAgICAgICB0aGlzLmdldEluZCh0aGlzLmluZGV4KTtcbiAgICB9XG4gICAgZ2V0SW5kKG51bTpudW1iZXIpe1xuICAgICAgICB0aGlzLmhlZ2VsU2VydmljZS5nZXRIZWdlbChudW0pLnN1YnNjcmliZShyZXMgPT4gdGhpcy5oZWdlbCA9IHJlcyk7XG4gICAgfTtcbiAgICBnZXRUZXJtKHRlcm06c3RyaW5nKXtcbiAgICAgICAgdGVybSA9IHRlcm0ucmVwbGFjZSgvWzAtOV0vZywgJycpO1xuICAgICAgICB0ZXJtID0gdGVybS5yZXBsYWNlKC9cXC4vZywgJycpO1xuICAgICAgICB0aGlzLmdldFdpa2kodGVybSk7XG4gICAgfVxuICAgIGhhbmRsZUxpbmsoJGV2ZW50OmFueSl7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiTGluayBoYW5kbGluZ1wiKTtcbiAgICAgICAgbGV0IGhyZWYgPSAkZXZlbnQudGFyZ2V0LmhyZWY7XG4gICAgICAgIGhyZWYgPSBocmVmLnNsaWNlKDI3LCBocmVmLmxlbmd0aCk7XG4gICAgICAgIHRoaXMuZ2V0V2lraShocmVmKTtcbiAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICB9XG4gICAgaGFuZGxlV2lraXBlZGlhTGluaygkZXZlbnQ6YW55KXtcbiAgICAgICAgY29uc29sZS5sb2coXCJIYW5kbGluZyBXaWtpIExpbmtcIik7XG4gICAgICAgIHRoaXMuaGVnZWxTZXJ2aWNlLmhhbmRsZVdpa2lwZWRpYUxpbmsoJGV2ZW50KTtcbiAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICAgIGdldFdpa2kod29yZDpzdHJpbmcpe1xuICAgICAgICB3b3JkID0gdGhpcy5oZWdlbFNlcnZpY2UucmVwbGFjZVVuZGVyc2NvcmVBbmRDYXAod29yZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQ2hlY2tpbmcgd29yZFwiICsgd29yZClcbiAgICAgICAgdmFyIGNhY2hlQ2hlY2sgPSB0aGlzLmNoZWNrQ2FjaGVGb3JUZXJtKHdvcmQpO1xuICAgICAgICBpZihjYWNoZUNoZWNrLmxlbmd0aCA+IDAgKSB7XG4gICAgICAgICAgICB0aGlzLmdldENhY2hlKHdvcmQpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmhlZ2VsU2VydmljZS5yZXF1ZXN0V2lraSh3b3JkKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjaGVja0NhY2hlRm9yVGVybSh0ZXJtOiBzdHJpbmcpe1xuICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5wcmV2aW91cy5maWx0ZXIoKHByZXY6YW55KT0+e1xuICAgICAgICAgICAgaWYocHJldi53b3JkID09IHRlcm0pe1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUmV0dXJuaW5nXCIgLCBwcmV2LndvcmQgKVxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBnZXRDYWNoZSh0ZXJtOnN0cmluZyl7XG4gICAgICAgIHZhciByZXN1bHQgPSB0aGlzLnByZXZpb3VzLmZpbHRlcigocHJldjphbnkpID0+IHtcbiAgICAgICAgICAgIGlmKHByZXYud29yZCA9PSB0ZXJtKXtcbiAgICAgICAgICAgICAgICBpZihwcmV2LnBhZ2Upe1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkdldHRpbmcgd2lraSBmcm9tIGNhY2hlXCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLndpa2kgPSBwcmV2LnBhZ2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cbiAgICBoYW5kbGVDYWNoZSh0ZXJtOmFueSl7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiSGFuZGxpbmcgY2FjaGVcIilcbiAgICAgICAgaWYodHlwZW9mKHRlcm0pID09ICdTdHJpbmcnKXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiR290IGEgc3RyaW5nIVwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZih0ZXJtLnBhZ2Upe1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTZXR0aW5nIHBhZ2VcIilcbiAgICAgICAgICAgIHRoaXMud2lraSA9IHRlcm0ucGFnZVxuICAgICAgICB9XG4gICAgfVxuICAgIGdldFNlbGVjdGlvblRleHQoKSB7XG4gICAgICAgIHZhciB0ZXh0ID0gXCJcIjtcbiAgICAgICAgaWYgKHdpbmRvdy5nZXRTZWxlY3Rpb24pIHtcbiAgICAgICAgICAgIHRleHQgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkudG9TdHJpbmcoKTtcbiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5zZWxlY3Rpb24gJiYgZG9jdW1lbnQuc2VsZWN0aW9uLnR5cGUgIT0gXCJDb250cm9sXCIpIHtcbiAgICAgICAgICAgIHRleHQgPSBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKS50ZXh0O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0ZXh0O1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICAvL0dldCB0aGUgZmlyc3QgcGFnZVxuICAgICAgICB0aGlzLmdldEluZCh0aGlzLmluZGV4KTtcblxuICAgICAgICB2YXIgcyA9IFJ4Lk9ic2VydmFibGUuZnJvbUV2ZW50KHRoaXMuX2RvbS5xdWVyeSgnYm9keScpLCAnY2xpY2snKTtcbiAgICAgICAgcy5zdWJzY3JpYmUoZSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlLnRhcmdldC50ZXh0Q29udGVudCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlNlbGVjdGlvbiB0ZXh0IVwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nICh0aGlzLmdldFNlbGVjdGlvblRleHQoKSlcbiAgICAgICAgICAgIHRyeXtcbiAgICAgICAgICAgICAgICBpZihlLnRhcmdldC5jbGFzc05hbWUgPT0gXCJ0ZXJtXCIpe1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVDaGVjayA9IHRoaXMuY2hlY2tDYWNoZUZvclRlcm0oZS50YXJnZXQuY29tcHV0ZWROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgaWYoY2FjaGVDaGVjay5sZW5ndGggPiAwKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiR290dGEgaGFuZGxlIHRoYXRcIilcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2FjaGUoZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkNhY2hlIGNoZWNrXCIgLCBjYWNoZUNoZWNrKVxuICAgICAgICAgICAgICAgICAgICBpZihjYWNoZUNoZWNrLmxlbmd0aCA+IDAgKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2FjaGUoY2FjaGVDaGVja1swXSk7XG4gICAgICAgICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJjb21wdXRlZCBuYW1lXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlLnRhcmdldC5jb21wdXRlZE5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFRlcm0oXCJDYXRlZ29yeTpcIiArIGUudGFyZ2V0LmNvbXB1dGVkTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYoZS50YXJnZXQuY2xhc3NOYW1lID09IFwibGlua3NcIil7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibGluayBuYW1lXCIpXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUub3JpZ2luYWxUYXJnZXQuaW5uZXJIdG1sKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFRlcm0oZS50YXJnZXQudGV4dENvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihlLnRhcmdldC5jbGFzc05hbWUgPT0gXCJwcmV2c1wiKXtcbiAgICAgICAgICAgICAgICB2YXIgdGVybSA9IHRoaXMuY2hlY2tDYWNoZUZvclRlcm0oZS50YXJnZXQuY29tcHV0ZWROYW1lKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkxvZ2dpbmcgdGVybSBmcm9tIGNhY2hlXCIgLCB0ZXJtKTtcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUNhY2hlKHRlcm1bMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0ZXJtID0gdGhpcy5nZXRTZWxlY3Rpb25UZXh0KClcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRUZXJtICh0ZXJtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIChleCl7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pXG4gICAgICAgICBmdW5jdGlvbiBjaGVja0ZvckJhZGRpZXMoY2F0OnN0cmluZywgYmFkZGllczphbnkpe1xuICAgICAgICAgICAgbGV0IGV4aXN0cyA9IGZhbHNlO1xuICAgICAgICAgICAgYmFkZGllcy5mb3JFYWNoKChiYWQ6c3RyaW5nKT0+e1xuICAgICAgICAgICAgICAgIGlmKGNhdC5pbmRleE9mKGJhZCkgPiAtMSl7XG4gICAgICAgICAgICAgICAgICAgIGV4aXN0cyA9IHRydWVcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgcmV0dXJuIGV4aXN0cztcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGZpbHRlck91dEJhZENhdGVnb3JpZXMoY2F0ZWdvcmllczphbnkpe1xuICAgICAgICAgICAgbGV0IHJlc3VsdHM6YW55W10gPVtdO1xuICAgICAgICAgICAgbGV0IGJhZGRpZXMgPSBbXCJXaWtpcGVkaWFcIiwgXCJVc2UgZG15IGRhdGVzXCIgLFwiVXNlIG1keSBkYXRlc1wiLFwiQWxsIGFydGljbGVzXCIsXCJBcnRpY2xlc1wiLFwiTlBPVlwiLCBcIkNTMVwiLFxuICAgICAgICAgICAgICAgICAgICAgICBcIkNvbW1vbnMgY2F0ZWdvcnkgd2l0aCBsb2NhbFwiLCBcIkhpZGRlbiBjYXRlZ29yaWVzXCIsIFwiVHJhY2tpbmcgY2F0ZWdvcmllc1wiLCBcIlBhZ2VzIHdpdGggVVJMIGVycm9yc1wiICwgXCJkaXNhbWJpZ3VhdGlvblwiLCBcIlBhZ2VzIHdpdGggaW5jb3JyZWN0IHJlZiBmb3JtYXR0aW5nXCJdXG4gICAgICAgICAgICBjYXRlZ29yaWVzID0gY2F0ZWdvcmllcy5maWx0ZXIoIChjYXQ6YW55KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYoY2hlY2tGb3JCYWRkaWVzKGNhdCwgYmFkZGllcykgPT0gZmFsc2Upe1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goY2F0KVxuICAgICAgICAgICAgICAgIH0gZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJCYWQgQ2F0ZWdvcnkgXCIgLCBjYXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0cztcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBzcmMgPSBSeC5PYnNlcnZhYmxlLmZyb21FdmVudCggdGhpcy5oZWdlbFNlcnZpY2Uuc29ja2V0LCAnd2lraVNlbmQnKTtcbiAgICAgICAgdmFyIHN1YmplY3QgPSBuZXcgUnguU3ViamVjdCgpO1xuICAgICAgICB2YXIgbXVsdGljYXN0ZWQgPSBzcmMubXVsdGljYXN0KHN1YmplY3QpO1xuXG4gICAgICAgIHZhciBkaWN0czphbnlbXSA9IFtdO1xuICAgICAgICB2YXIgY2F0ZWdvcmllczphbnlbXSA9IFtdO1xuXG4gICAgICAgIG11bHRpY2FzdGVkLmZpbHRlcihlID0+IHtpZihlLmRpY3Rpb25hcmllcyl7IGRpY3RzID0gZS5kaWN0aW9uYXJpZXM7IHJldHVybiBlLmRpY3Rpb25hcmllc319KS5zdWJzY3JpYmUobXNnID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGljdGlvbmFyaWVzID0gbXNnLmRpY3Rpb25hcmllcztcbiAgICAgICAgICAgIHRoaXMuZGVmcyA9IG1zZy5kaWN0aW9uYXJpZXMuaW5mby5tYXAoKGVudHJ5OmFueSk9PntcbiAgICAgICAgICAgICAgICByZXR1cm4gZW50cnkuZGVmO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIHRoaXMuZ2xvc3NlcyA9IG1zZy5kaWN0aW9uYXJpZXMuaW5mby5tYXAoKGRlZjphbnkpPT57cmV0dXJuIGRlZi5nbG9zc30pO1xuICAgICAgICB9KVxuXG4gICAgICAgIG11bHRpY2FzdGVkLmZpbHRlcihlID0+IHtcbiAgICAgICAgICAgIGlmKGUuY2F0ZWdvcmllcyl7XG4gICAgICAgICAgICAgICAgY2F0ZWdvcmllcyA9IGUuY2F0ZWdvcmllcztcbiAgICAgICAgICAgICAgICByZXR1cm4gZS5jYXRlZ29yaWVzO1xuICAgICAgICAgICAgfX0pXG4gICAgICAgICAgICAuc3Vic2NyaWJlKG1zZyA9PiB7XG4gICAgICAgICAgICAgICAgbXNnID0gbXNnLmNhdGVnb3JpZXM7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXM9ZmFsc2U7XG4gICAgICAgICAgICAgICAgbXNnID0gbXNnLm1hcCgoY2F0OnN0cmluZyk9PntcbiAgICAgICAgICAgICAgICAgICAgY2F0ID0gY2F0LnN1YnN0cmluZyg5LGNhdC5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2F0LmluZGV4T2YoXCJBbGwgZGlzYW1iaWd1YXRpb24gcGFnZXNcIikgPiAtMSl7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhdDtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIHZhciByZXN1bHRzID0gZmlsdGVyT3V0QmFkQ2F0ZWdvcmllcyhtc2cpO1xuICAgICAgICAgICAgICAgIHRoaXMudGVybXMgPSByZXN1bHRzO1xuICAgICAgICB9KVxuICAgICAgICBtdWx0aWNhc3RlZC5maWx0ZXIoZSA9PiB7XG4gICAgICAgICAgICBpZihlLndvcmQpe1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwid29yZFwiICwgZS53b3JkKVxuICAgICAgICAgICAgICAgIGxldCBwcmV2aW91c09iaiA9IHsgd29yZDogZS53b3JkLCBwYWdlOiBlLnBhZ2V9O1xuICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c09iai53b3JkICE9PSBcIlwiKXtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmV2aW91cy5wdXNoKHByZXZpb3VzT2JqLndvcmQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoZS5wYWdlKXtcbiAgICAgICAgICAgICAgICB0aGlzLndpa2kgPSBlLnBhZ2U7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByZXR1cm4gZS5wYWdlXG4gICAgICAgIH0pLnN1YnNjcmliZShlID0+IHt9KVxuXG4gICAgICAgIG11bHRpY2FzdGVkLmZpbHRlcihlID0+IHtpZihlLnJlc3VsdHMpe3RoaXMudGVybXMgPSBlLnJlc3VsdHN9OyByZXR1cm4gZS5yZXN1bHRzfSkuc3Vic2NyaWJlKGUgPT4ge1xuICAgICAgICAgICAgLy9cbiAgICAgICAgfSlcbiAgICAgICAgbXVsdGljYXN0ZWQuZmlsdGVyKGUgPT4ge2lmKGUubGlua3Mpe3RoaXMubGlua3MgPSBlLmxpbmtzfTsgcmV0dXJuIGUubGlua3N9KS5zdWJzY3JpYmUoZSA9PiB7XG4gICAgICAgICAgICAvL1xuICAgICAgICB9KVxuICAgICAgICBtdWx0aWNhc3RlZC5jb25uZWN0KCk7XG4gICAgfTtcbn07XG4iXX0=
